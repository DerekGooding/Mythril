@using Microsoft.JSInterop
@using Mythril.Data
@inject IJSRuntime JS

<div class="task-progress-card @(QuestProgress?.IsCompleted == true ? "completed" : "")" @ref="cardElement">
    <div class="task-header">@QuestProgress?.Name</div>
    <div class="task-body">
        <p>@QuestProgress?.Description</p>
        <div class="progress">
            <div class="progress-bar" 
                 role="progressbar" 
                 style="width: @((QuestProgress?.Progress * 100)?.ToString() ?? "0")%;" 
                 aria-valuenow="@((QuestProgress?.Progress * 100) ?? 0.0)" 
                 aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
    </div>
    <div class="task-duration">
        @QuestProgress?.DurationSeconds s
    </div>
</div>

@code {
    [Parameter]
    public QuestProgress? QuestProgress { get; set; }

    [Parameter]
    public EventCallback OnCompletionAnimationEnd { get; set; }

    private ElementReference cardElement;

    private bool _hasTriggeredCompletion = false;

    protected override async Task OnParametersSetAsync()
    {
        if (QuestProgress?.IsCompleted == true && !_hasTriggeredCompletion)
        {
            _hasTriggeredCompletion = true;
            await TriggerConfetti();
            await Task.Delay(1000); // Duration of the gold flash animation
            await OnCompletionAnimationEnd.InvokeAsync();
        }
    }

    private async Task TriggerConfetti()
    {
        await JS.InvokeVoidAsync("triggerConfettiAt", cardElement);
    }
}
