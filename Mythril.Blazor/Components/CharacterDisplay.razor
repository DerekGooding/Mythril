@using Mythril.Data
@inject Stats statsContent
@inject ResourceManager resourceManager
@inject JunctionManager JunctionManager

<div class="character-display">
    <div class="character-header">
        <div class="d-flex flex-column">
            <h4>@Character.Name</h4>
            <div class="cadence-info small text-muted">
                Cadence: @(JunctionManager.CurrentlyAssigned(Character).FirstOrDefault().Name ?? "None")
            </div>
        </div>
        <div class="stats-mini">
            @foreach (var stat in statsContent.All.Take(9))
            {
                var val = JunctionManager.GetStatValue(Character, stat.Name);
                var junction = JunctionManager.Junctions.FirstOrDefault(j => j.Character.Name == Character.Name && j.Stat.Name == stat.Name);
                
                <span class="stat-badge @(junction != null ? "junctioned" : "")" title="@stat.Description @(junction != null ? $"(J: {junction.Magic.Name})" : "")">
                    @stat.Name[0]: @val
                </span>
            }
        </div>
    </div>

    @if (JunctionManager.CurrentlyAssigned(Character).Any())
    {
        <div class="junction-controls mb-2">
            <button class="btn btn-sm btn-outline-primary" @onclick="ToggleJunctionMenu">Junction</button>
        </div>
    }
    
    @if (_showJunctionMenu)
    {
        <div class="junction-menu card p-2 mb-2">
            <h6>Junction Magic</h6>
            <div class="junction-grid">
                @foreach (var stat in statsContent.All.Take(9))
                {
                    bool canJunction = CanJunction(stat);
                    var currentJ = JunctionManager.Junctions.FirstOrDefault(j => j.Character.Name == Character.Name && j.Stat.Name == stat.Name);
                    
                    <div class="junction-row d-flex justify-content-between align-items-center mb-1">
                        <span class="small @(canJunction ? "" : "text-muted")">@stat.Name</span>
                        @if (canJunction)
                        {
                            <select class="form-select form-select-sm w-auto" @onchange="(e) => HandleJunctionChange(stat, e)">
                                <option value="">None</option>
                                @foreach (var spell in resourceManager.Inventory.GetSpells())
                                {
                                    <option value="@spell.Item.Name" selected="@(currentJ?.Magic.Name == spell.Item.Name)">
                                        @spell.Item.Name (@spell.Quantity)
                                    </option>
                                }
                            </select>
                        }
                        else
                        {
                            <span class="badge bg-light text-dark small">Locked</span>
                        }
                    </div>
                }
            </div>
        </div>
    }
    
    @if (QuestProgress is not null)
    {
        <QuestProgressCard QuestProgress="QuestProgress" OnCompletionAnimationEnd="() => OnCompletionAnimationEnd.InvokeAsync(QuestProgress)" />
    }
    else
    {
        <DropZone OnQuestDrop="HandleTaskDrop" Accepts="Accepts" />
    }
</div>

<style>
    .character-display {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fdfdfd;
    }
    .character-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .stats-mini {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-width: 200px;
    }
    .stat-badge {
        font-size: 0.75rem;
        background: #eee;
        padding: 2px 4px;
        border-radius: 4px;
        cursor: help;
        transition: all 0.2s;
    }
    .stat-badge.junctioned {
        background: #d1e7ff;
        color: #0056b3;
        font-weight: bold;
        border: 1px solid #0056b3;
    }
    .junction-menu {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        max-height: 300px;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter]
    public Character Character { get; set; }

    [Parameter]
    public QuestProgress? QuestProgress { get; set; }

    [Parameter]
    public EventCallback<object> OnQuestDrop { get; set; }

    [Parameter]
    public Func<object, bool>? Accepts { get; set; }

    [Parameter]
    public EventCallback<QuestProgress> OnCompletionAnimationEnd { get; set; }

    private bool _showJunctionMenu = false;

    private void ToggleJunctionMenu() => _showJunctionMenu = !_showJunctionMenu;

    private bool CanJunction(Stat stat)
    {
        var cadence = JunctionManager.CurrentlyAssigned(Character).FirstOrDefault();
        if (cadence.Name == null) return false;
        
        string abilityName = "J-" + stat.Name;
        if (stat.Name == "Health") abilityName = "J-HP";
        if (stat.Name == "Vitality") abilityName = "J-Vit";
        if (stat.Name == "Strength") abilityName = "J-Str";

        return cadence.Abilities.Any(a => resourceManager.UnlockedAbilities.Contains(a.Ability) && a.Ability.Name == abilityName);
    }

    private void HandleJunctionChange(Stat stat, ChangeEventArgs e)
    {
        string magicName = e.Value?.ToString() ?? "";
        var magic = resourceManager.Inventory.GetSpells().FirstOrDefault(s => s.Item.Name == magicName).Item;
        JunctionManager.JunctionMagic(Character, stat, magic, resourceManager.UnlockedAbilities);
        StateHasChanged();
    }

    private void HandleTaskDrop(object task)
    {
        OnQuestDrop.InvokeAsync(task);
    }
}
