@using Mythril.Data
@using Mythril.Blazor.Services
@inject Stats statsContent
@inject ResourceManager resourceManager
@inject JunctionManager JunctionManager
@inject DragDropService DragDropService

<div class="character-display">
    <div class="character-header">
        <div class="d-flex flex-column flex-grow-1 min-width-0">
            <h4 draggable="true" @ondragstart="HandleCharacterDragStart" class="draggable-name text-truncate">@Character.Name</h4>
            <div class="cadence-info small text-muted text-truncate">
                Cadence: @(JunctionManager.CurrentlyAssigned(Character).FirstOrDefault().Name ?? "None")
            </div>
        </div>
        <div class="stats-container">
            <div class="stats-mini">
                @foreach (var stat in statsContent.All.Take(9))
                {
                    var val = JunctionManager.GetStatValue(Character, stat.Name);
                    var junction = JunctionManager.Junctions.FirstOrDefault(j => j.Character.Name == Character.Name && j.Stat.Name == stat.Name);
                    
                    <span class="stat-badge @(junction != null ? "junctioned" : "")" title="@stat.Description @(junction != null ? $"(J: {junction.Magic.Name})" : "")">
                        @stat.Name[0]: @val
                    </span>
                }
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2">
        @if (JunctionManager.CurrentlyAssigned(Character).Any())
        {
            <div class="junction-controls">
                <button class="btn btn-xs btn-outline-primary" @onclick="ToggleJunctionMenu">Junction</button>
            </div>
        }
        
        <div class="flex-grow-1 ms-2">
            @if (QuestProgress is not null)
            {
                <QuestProgressCard QuestProgress="QuestProgress" OnCompletionAnimationEnd="() => OnCompletionAnimationEnd.InvokeAsync(QuestProgress)" />
            }
            else
            {
                <DropZone OnQuestDrop="HandleTaskDrop" Accepts="Accepts" />
            }
        </div>
    </div>
    
    @if (_showJunctionMenu)
    {
        <div class="junction-menu card p-2">
            <h6>Junction Magic</h6>
            <div class="junction-grid">
                @foreach (var stat in statsContent.All.Take(9))
                {
                    bool canJunction = CanJunction(stat);
                    var currentJ = JunctionManager.Junctions.FirstOrDefault(j => j.Character.Name == Character.Name && j.Stat.Name == stat.Name);
                    
                    <div class="junction-row d-flex justify-content-between align-items-center mb-1">
                        <span class="small @(canJunction ? "" : "text-muted")">@stat.Name</span>
                        @if (canJunction)
                        {
                            <select class="form-select form-select-sm w-auto" @onchange="(e) => HandleJunctionChange(stat, e)">
                                <option value="">None</option>
                                @foreach (var spell in resourceManager.Inventory.GetSpells())
                                {
                                    <option value="@spell.Item.Name" selected="@(currentJ?.Magic.Name == spell.Item.Name)">
                                        @spell.Item.Name (@spell.Quantity)
                                    </option>
                                }
                            </select>
                        }
                        else
                        {
                            <span class="badge bg-light text-dark small">Locked</span>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .character-display {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.75rem;
        background: #fdfdfd;
        position: relative;
    }
    .character-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }
    .stats-container {
        flex-shrink: 0;
        background: #f0f0f0;
        padding: 4px;
        border-radius: 6px;
        max-width: 60%;
    }
    .stats-mini {
        display: flex;
        flex-wrap: nowrap !important;
        gap: 0.25rem;
        overflow-x: auto;
        padding-bottom: 2px; /* For scrollbar space if needed */
    }
    .stat-badge {
        font-size: 0.65rem;
        background: #fff;
        padding: 1px 4px;
        border: 1px solid #eee;
        border-radius: 3px;
        cursor: help;
        transition: all 0.2s;
        white-space: nowrap;
        flex-shrink: 0;
    }
    .stat-badge.junctioned {
        background: #d1e7ff;
        color: #0056b3;
        font-weight: bold;
        border: 1px solid #0056b3;
    }
    .junction-menu {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        max-height: 250px;
        overflow-y: auto;
        position: absolute;
        bottom: 100%;
        left: 0;
        z-index: 1000;
        width: 280px;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
        margin-bottom: 5px;
    }
    .junction-grid {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .draggable-name {
        cursor: grab;
        user-select: none;
        margin: 0;
        font-size: 1.1rem;
    }
    .draggable-name:hover {
        color: #007bff;
        text-decoration: underline;
    }
    .draggable-name:active {
        cursor: grabbing;
    }
    .btn-xs {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
    }
</style>

@code {
    [Parameter]
    public Character Character { get; set; }

    [Parameter]
    public QuestProgress? QuestProgress { get; set; }

    [Parameter]
    public EventCallback<object> OnQuestDrop { get; set; }

    [Parameter]
    public Func<object, bool>? Accepts { get; set; }

    [Parameter]
    public EventCallback<QuestProgress> OnCompletionAnimationEnd { get; set; }

    private bool _showJunctionMenu = false;

    private void ToggleJunctionMenu() => _showJunctionMenu = !_showJunctionMenu;

    private void HandleCharacterDragStart(DragEventArgs args)
    {
        DragDropService.Data = Character;
    }

    private bool CanJunction(Stat stat)
    {
        var cadence = JunctionManager.CurrentlyAssigned(Character).FirstOrDefault();
        if (cadence.Name == null) return false;
        
        string abilityName = "J-" + stat.Name;
        if (stat.Name == "Health") abilityName = "J-HP";
        if (stat.Name == "Vitality") abilityName = "J-Vit";
        if (stat.Name == "Strength") abilityName = "J-Str";

        return cadence.Abilities.Any(a => resourceManager.UnlockedAbilities.Contains(a.Ability) && a.Ability.Name == abilityName);
    }

    private void HandleJunctionChange(Stat stat, ChangeEventArgs e)
    {
        string magicName = e.Value?.ToString() ?? "";
        var magic = resourceManager.Inventory.GetSpells().FirstOrDefault(s => s.Item.Name == magicName).Item;
        JunctionManager.JunctionMagic(Character, stat, magic, resourceManager.UnlockedAbilities);
        StateHasChanged();
    }

    private void HandleTaskDrop(object task)
    {
        OnQuestDrop.InvokeAsync(task);
    }
}
