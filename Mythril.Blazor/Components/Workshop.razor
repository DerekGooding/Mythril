@using Mythril.Data
@using Mythril.Blazor.Services
@inject ResourceManager resourceManager
@inject ItemRefinements refinements
@inject SnackbarService SnackbarService

<div class="workshop">
    <h3>Item Refinement Workshop</h3>
    <p>Utilize your unlocked Cadence abilities to refine materials.</p>

    @foreach (var refinement in refinements.ByKey)
    {
        var ability = refinement.Key;
        var hasAbility = resourceManager.UnlockedAbilities.Contains(ability);
        
        <div class="refinement-group @(hasAbility ? "" : "locked")">
            <h4>@ability.Name @(hasAbility ? "" : "(Locked)")</h4>
            
            <div class="recipe-list">
                @foreach (var recipeKvp in refinement.Value)
                {
                    var inputItem = recipeKvp.Key;
                    var recipe = recipeKvp.Value;
                    var canAfford = resourceManager.Inventory.Has(inputItem, recipe.InputQuantity);
                    
                    <div class="recipe-card">
                        <div class="recipe-details">
                            <span>@recipe.InputQuantity x @inputItem.Name</span>
                            <span class="arrow">â†’</span>
                            <span>@recipe.OutputQuantity x @recipe.OutputItem.Name</span>
                        </div>
                        <button class="btn btn-sm @(canAfford && hasAbility ? "btn-success" : "btn-secondary")" 
                                disabled="@(!(canAfford && hasAbility))"
                                @onclick="() => Craft(inputItem, recipe)">
                            Craft
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .workshop {
        padding: 1rem;
    }
    .refinement-group {
        margin-bottom: 2rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
    }
    .refinement-group.locked {
        opacity: 0.5;
        filter: grayscale(1);
    }
    .recipe-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }
    .recipe-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
    }
    .recipe-details {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    .arrow {
        font-weight: bold;
        color: #888;
    }
</style>

@code {
    private void Craft(Item inputItem, Recipe recipe)
    {
        if (resourceManager.Inventory.Remove(inputItem, recipe.InputQuantity))
        {
            resourceManager.Inventory.Add(recipe.OutputItem, recipe.OutputQuantity);
            SnackbarService.Show($"Crafted {recipe.OutputQuantity}x {recipe.OutputItem.Name}", "success");
            StateHasChanged();
        }
    }
}
