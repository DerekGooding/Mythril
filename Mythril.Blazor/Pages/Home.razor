@page "/"
@using Mythril.Blazor.Services
@using Mythril.Data
@using System.Threading.Tasks

@inject ResourceManager resourceManager
@inject ThemeService themeService
@inject NavigationManager navigationManager
@inject SnackbarService SnackbarService

<PageTitle>Mythril</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <button class="btn btn-primary" @onclick="ToggleTheme">Toggle Theme</button>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            @if (resourceManager is not null)
            {
                <InventoryPanel Items="resourceManager.Inventory?.GetItems().ToList()" />
            }
        </div>
    </div>
    <div class="row">
        <!-- Left column with tabs -->
        <div class="col-6">
            @if (resourceManager is not null)
            {
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="hand-tab" data-bs-toggle="tab" data-bs-target="#hand" type="button" role="tab">
                            Locations
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cadence-tab" data-bs-toggle="tab" data-bs-target="#cadence" type="button" role="tab">
                            Cadence
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-2 border border-top-0">
                    <div class="tab-pane fade show active" id="hand" role="tabpanel">
                        <HandPanel Locations="resourceManager.UsableLocations" />
                    </div>
                    <div class="tab-pane fade" id="cadence" role="tabpanel">
                        <CadencePanel Cadences="resourceManager.UnlockedCadences" />
                    </div>
                </div>
            }
            else
            {
                <p><em>Loading...</em></p>
            }
        </div>

        <!-- Right column with PartyPanel -->
        <div class="col-6">
            @if (resourceManager is not null)
            {
                <PartyPanel Party="resourceManager.Characters"
                            QuestProgresses="questProgresses"
                            OnQuestDrop="EventCallback.Factory.Create<(object, Character)>(this, TaskDropped)" />
            }
            else
            {
                <p><em>Loading...</em></p>
            }
        </div>
    </div>
</div>

@using System.Timers
@code {
    private List<QuestProgress> questProgresses = new();
    private Timer? timer;

    protected override void OnInitialized()
    {
        timer = new Timer(100);
        timer.Elapsed += (sender, args) => { _ = Task.Run(OnTimerElapsed); };
        timer.AutoReset = true;
        timer.Enabled = true;

        themeService.OnThemeChanged += StateHasChanged;
    }

    private async Task ToggleTheme()
    {
        await themeService.ToggleTheme();
        navigationManager.NavigateTo(navigationManager.Uri, forceLoad: true);
    }

    private async Task TaskDropped((object item, Character character) args)
    {
        if (resourceManager.CanAfford(args.item))
        {
            resourceManager.PayCosts(args.item);
            if(args.item is QuestData quest)
                questProgresses.Add(new QuestProgress(quest, quest.Description, quest.DurationSeconds, args.character));
            if(args.item is CadenceUnlock unlock)
                questProgresses.Add(new QuestProgress(unlock, unlock.Ability.Description, 3, args.character));

            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnTimerElapsed()
    {
        const int completdThreshold = 105;
        var newlyCompletedQuests = new List<QuestProgress>();
        for (int i = 0; i < questProgresses.Count; i++)
        {
            var progress = questProgresses[i];
            if (progress.Progress < completdThreshold)
            {
                var elapsed = (DateTime.Now - progress.StartTime).TotalSeconds;
                progress.Progress = Math.Min(completdThreshold, (elapsed / progress.DurationSeconds) * 100);

                if (progress.Progress >= completdThreshold)
                {
                    newlyCompletedQuests.Add(progress);
                }
            }
        }

        await InvokeAsync(StateHasChanged);

        if (newlyCompletedQuests.Any())
        {
            foreach (var progress in newlyCompletedQuests)
            {
                await resourceManager.ReceiveRewards(progress.Item);
                SnackbarService.Show($"Completed: {progress.Name}", "success");
            }
            questProgresses.RemoveAll(p => p.Progress >= completdThreshold);
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
        themeService.OnThemeChanged -= StateHasChanged;
    }
}
