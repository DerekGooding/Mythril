@page "/"
@using Mythril.Blazor.Services
@using Mythril.Data
@using System.Threading.Tasks

@inject ResourceManager resourceManager
@inject ThemeService themeService
@inject NavigationManager navigationManager
@inject SnackbarService SnackbarService
@inject AuthService AuthService

<PageTitle>Mythril</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <button class="btn btn-primary" @onclick="ToggleTheme">Toggle Theme</button>
            @if (AuthService.IsAuthenticated)
            {
                <button class="btn @(resourceManager.IsTestMode ? "btn-warning" : "btn-outline-secondary")" 
                        @onclick="ToggleTestMode">
                    Test Mode: @(resourceManager.IsTestMode ? "ON" : "OFF")
                </button>
            }
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            @if (resourceManager is not null)
            {
                <InventoryPanel Items="resourceManager.Inventory?.GetItems().ToList()" />
            }
        </div>
    </div>
    <div class="row home-columns-row">
        <!-- Left column with tabs -->
        <div class="col-6">
            @if (resourceManager is not null)
            {
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="hand-tab" data-bs-toggle="tab" data-bs-target="#hand" type="button" role="tab">
                            Locations
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cadence-tab" data-bs-toggle="tab" data-bs-target="#cadence" type="button" role="tab">
                            Cadence
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="workshop-tab" data-bs-toggle="tab" data-bs-target="#workshop" type="button" role="tab">
                            Workshop
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-2 border border-top-0">
                    <div class="tab-pane fade show active" id="hand" role="tabpanel">
                        <HandPanel Locations="resourceManager.UsableLocations" />
                    </div>
                    <div class="tab-pane fade" id="cadence" role="tabpanel">
                        <CadencePanel Cadences="resourceManager.UnlockedCadences" />
                    </div>
                    <div class="tab-pane fade" id="workshop" role="tabpanel">
                        <Workshop />
                    </div>
                </div>
            }
            else
            {
                <p><em>Loading...</em></p>
            }
        </div>

        <!-- Right column with PartyPanel -->
        <div class="col-6">
            @if (resourceManager is not null)
            {
                <PartyPanel Party="resourceManager.Characters"
                            QuestProgresses="resourceManager.ActiveQuests"
                            OnQuestDrop="EventCallback.Factory.Create<(object, Character)>(this, TaskDropped)"
                            OnCompletionAnimationEnd="EventCallback.Factory.Create<QuestProgress>(this, OnCompletionAnimationEnd)" />
            }
            else
            {
                <p><em>Loading...</em></p>
            }
        </div>
    </div>
</div>

@using System.Timers
@code {
    private Timer? timer;

    protected override void OnInitialized()
    {
        timer = new Timer(100);
        timer.Elapsed += (sender, args) => { _ = Task.Run(OnTimerElapsed); };
        timer.AutoReset = true;
        timer.Enabled = true;

        themeService.OnThemeChanged += StateHasChanged;
    }

    private async Task ToggleTheme()
    {
        await themeService.ToggleTheme();
    }

    private void ToggleTestMode()
    {
        resourceManager.IsTestMode = !resourceManager.IsTestMode;
    }

    private async Task TaskDropped((object item, Character character) args)
    {
        resourceManager.StartQuest(args.item, args.character);
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTimerElapsed()
    {
        resourceManager.Tick(0.1); 
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        timer?.Dispose();
        themeService.OnThemeChanged -= StateHasChanged;
    }

    protected async Task OnCompletionAnimationEnd(QuestProgress completedProgress)
    {
        await resourceManager.ReceiveRewards(completedProgress.Item);
        resourceManager.ActiveQuests.Remove(completedProgress);
        SnackbarService.Show($"Completed: {completedProgress.Name}", "success");
        await InvokeAsync(StateHasChanged);
    }
}
