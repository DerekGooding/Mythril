@page "/"
@using Mythril.Blazor.Services
@using Mythril.Data
@using System.Threading.Tasks

@inject ResourceManager resourceManager
@inject JunctionManager JunctionManager
@inject ThemeService themeService
@inject NavigationManager navigationManager
@inject SnackbarService SnackbarService
@inject AuthService AuthService
@inject PersistenceService persistenceService

<PageTitle>Mythril</PageTitle>

<div class="container-fluid d-flex flex-column h-100 p-0">
    <!-- Header Row -->
    <div class="header-row flex-shrink-0 p-2 border-bottom d-flex align-items-center gap-2">
        <button class="btn btn-primary" @onclick="ToggleTheme">Toggle Theme</button>
        @if (AuthService.IsAuthenticated)
        {
            <button class="btn @(resourceManager.IsTestMode ? "btn-warning" : "btn-outline-secondary")" 
                    @onclick="ToggleTestMode">
                Test Mode: @(resourceManager.IsTestMode ? "ON" : "OFF")
            </button>
            <button class="btn btn-outline-success" @onclick="SaveGame">Save Game</button>
        }
        <div class="flex-grow-1">
            @if (resourceManager is not null)
            {
                <InventoryPanel Items="resourceManager.Inventory?.GetItems().ToList()" />
            }
        </div>
    </div>

    <!-- Main Content Area: Two Columns -->
    <div class="row home-columns-row flex-grow-1 min-height-0 m-0">
        <!-- Left column with tabs -->
        <div class="col-8 d-flex flex-column h-100 p-2">
            @if (resourceManager is not null)
            {
                <ul class="nav nav-tabs flex-shrink-0" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="hand-tab" data-bs-toggle="tab" data-bs-target="#hand" type="button" role="tab">
                            Locations
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cadence-tab" data-bs-toggle="tab" data-bs-target="#cadence" type="button" role="tab">
                            Cadence
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="workshop-tab" data-bs-toggle="tab" data-bs-target="#workshop" type="button" role="tab">
                            Workshop
                        </button>
                    </li>
                </ul>
                <div class="tab-content flex-grow-1 min-height-0 border border-top-0 d-flex flex-column overflow-hidden">
                    <div class="tab-pane fade show active flex-grow-1 overflow-hidden d-flex flex-column" id="hand" role="tabpanel">
                        <HandPanel Locations="resourceManager.UsableLocations" />
                    </div>
                    <div class="tab-pane fade flex-grow-1 overflow-hidden d-flex flex-column" id="cadence" role="tabpanel">
                        <CadencePanel Cadences="resourceManager.UnlockedCadences" />
                    </div>
                    <div class="tab-pane fade flex-grow-1 overflow-hidden d-flex flex-column" id="workshop" role="tabpanel">
                        <Workshop />
                    </div>
                </div>
            }
            else
            {
                <p><em>Loading...</em></p>
            }
        </div>

        <!-- Right column with PartyPanel (Vertical listing) -->
        <div class="col-4 d-flex flex-column h-100 p-2 border-start bg-light">
            @if (resourceManager is not null)
            {
                <PartyPanel Party="resourceManager.Characters"
                            QuestProgresses="resourceManager.ActiveQuests"
                            OnQuestDrop="EventCallback.Factory.Create<(object, Character)>(this, TaskDropped)"
                            OnCompletionAnimationEnd="EventCallback.Factory.Create<QuestProgress>(this, OnCompletionAnimationEnd)" />
            }
            else
            {
                <p><em>Loading...</em></p>
            }
        </div>
    </div>
</div>

<style>
    .header-row {
        background-color: var(--bs-body-bg);
    }
    .tab-content {
        background-color: var(--bs-body-bg);
    }
    .tab-pane > * {
        flex-grow: 1;
        min-height: 0;
    }
</style>

@using System.Timers
@code {
    private Timer? timer;
    private int saveCounter = 0;

    protected override async Task OnInitializedAsync()
    {
        await persistenceService.LoadAsync();
        
        timer = new Timer(100);
        timer.Elapsed += (sender, args) => { _ = Task.Run(OnTimerElapsed); };
        timer.AutoReset = true;
        timer.Enabled = true;

        themeService.OnThemeChanged += StateHasChanged;
    }

    private async Task ToggleTheme()
    {
        await themeService.ToggleTheme();
    }

    private void ToggleTestMode()
    {
        resourceManager.IsTestMode = !resourceManager.IsTestMode;
    }

    private async Task SaveGame()
    {
        await persistenceService.SaveAsync();
        SnackbarService.Show("Game Saved", "info");
    }

    private async Task TaskDropped((object item, Character character) args)
    {
        if (args.item is Cadence cadence)
        {
            JunctionManager.AssignCadence(cadence, args.character, resourceManager.UnlockedAbilities);
            SnackbarService.Show($"{args.character.Name} equipped {cadence.Name}", "info");
        }
        else
        {
            resourceManager.StartQuest(args.item, args.character);
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTimerElapsed()
    {
        resourceManager.Tick(0.1); 
        
        saveCounter++;
        if (saveCounter >= 300) // Save every 30 seconds
        {
            saveCounter = 0;
            await persistenceService.SaveAsync();
        }

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        timer?.Dispose();
        themeService.OnThemeChanged -= StateHasChanged;
    }

    protected async Task OnCompletionAnimationEnd(QuestProgress completedProgress)
    {
        await resourceManager.ReceiveRewards(completedProgress.Item);
        resourceManager.RemoveActiveQuest(completedProgress);
        SnackbarService.Show($"Completed: {completedProgress.Name}", "success");
        await InvokeAsync(StateHasChanged);
    }
}
