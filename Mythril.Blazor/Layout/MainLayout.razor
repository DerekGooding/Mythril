@inherits LayoutComponentBase
@using Mythril.Blazor.Services
@inject PersistenceService Persistence
@inject SnackbarService Snackbar
@inject VersionService VersionService
@inject NavigationManager Navigation
@inject AuthService AuthService

<main>
    <div class="top-row px-4 justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-primary mx-2" @onclick="SaveGame">Save</button>
            <button class="btn btn-outline-secondary mx-2" @onclick="LoadGame">Load</button>
            <button class="btn btn-outline-info mx-2" @onclick="ToggleFeedback">Feedback</button>
        </div>
        
        <div class="version-info d-flex align-items-center">
            <span class="text-muted small mx-2" style="cursor: pointer; user-select: none;" @onclick="OnVersionClick">
                v: @(VersionService.CurrentVersion?.Substring(0, 7) ?? "local")
            </span>
            @if (VersionService.IsUpdateAvailable)
            {
                <button class="btn btn-sm btn-warning animate-pulse" @onclick="RefreshPage">
                    <span class="material-icons-outlined small" style="font-size: 1rem; vertical-align: middle;">refresh</span>
                    Update Available
                </button>
            }
        </div>
    </div>

    <div class="main-container">
        <article class="content">
            @Body
        </article>

        @if (_showFeedback)
        {
            <div class="feedback-drawer">
                <div class="drawer-header">
                    <h5>@(AuthService.IsAuthenticated ? "Developer Console" : "Feedback")</h5>
                    <button class="btn-close" @onclick="ToggleFeedback"></button>
                </div>
                <div class="drawer-content">
                    <FeedbackPanel />
                    @if (AuthService.IsAuthenticated)
                    {
                        <hr />
                        <button class="btn btn-sm btn-outline-danger w-100" @onclick="Logout">Disable Dev Mode</button>
                    }
                </div>
            </div>
            <div class="drawer-backdrop" @onclick="ToggleFeedback"></div>
        }
    </div>
    
    <Snackbar />
</main>

@code {
    private bool _showFeedback = false;
    private int _versionClicks = 0;

    protected override void OnInitialized()
    {
        VersionService.OnUpdateAvailable += async () => await InvokeAsync(StateHasChanged);
    }

    private void ToggleFeedback() 
    {
        _showFeedback = !_showFeedback;
    }

    private async Task OnVersionClick()
    {
        if (AuthService.IsAuthenticated) return;

        _versionClicks++;
        if (_versionClicks >= 3)
        {
            await AuthService.SetDevMode(true);
            _versionClicks = 0;
            Snackbar.Show("Developer mode unlocked!", "success");
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        Snackbar.Show("Developer mode disabled.", "info");
        StateHasChanged();
    }

    private void RefreshPage() => Navigation.NavigateTo(Navigation.Uri, forceLoad: true);

    private async Task SaveGame()
    {
        await Persistence.SaveAsync();
        Snackbar.Show("Game Saved!", "success");
    }

    private async Task LoadGame()
    {
        if (await Persistence.HasSave())
        {
            await Persistence.LoadAsync();
            Snackbar.Show("Game Loaded!", "success");
        }
        else
        {
            Snackbar.Show("No save found.", "warning");
        }
    }
}
