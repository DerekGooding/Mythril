@inherits LayoutComponentBase
@using Mythril.Blazor.Services
@inject PersistenceService Persistence
@inject SnackbarService Snackbar
@inject VersionService VersionService
@inject NavigationManager Navigation
@inject AuthService AuthService

<main>
    <div class="top-row px-4 justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-primary mx-2" @onclick="SaveGame">Save</button>
            <button class="btn btn-outline-secondary mx-2" @onclick="LoadGame">Load</button>
            @if (AuthService.IsAuthenticated)
            {
                <button class="btn btn-outline-info mx-2" @onclick="ToggleFeedback">Feedback</button>
            }
            else
            {
                <button class="btn btn-sm btn-link text-muted" @onclick="ToggleFeedback">Admin</button>
            }
        </div>
        
        <div class="version-info d-flex align-items-center">
            <span class="text-muted small mx-2">v: @(VersionService.CurrentVersion?.Substring(0, 7) ?? "local")</span>
            @if (VersionService.IsUpdateAvailable)
            {
                <button class="btn btn-sm btn-warning animate-pulse" @onclick="RefreshPage">
                    <span class="material-icons-outlined small" style="font-size: 1rem; vertical-align: middle;">refresh</span>
                    Update Available
                </button>
            }
        </div>
    </div>

    <div class="main-container">
        <article class="content">
            @Body
        </article>

        @if (_showFeedback)
        {
            <div class="feedback-drawer">
                <div class="drawer-header">
                    <h5>@(AuthService.IsAuthenticated ? "Developer Console" : "Admin Login")</h5>
                    <button class="btn-close" @onclick="ToggleFeedback"></button>
                </div>
                <div class="drawer-content">
                    @if (AuthService.IsAuthenticated)
                    {
                        <FeedbackPanel />
                        <hr />
                        <button class="btn btn-sm btn-outline-danger w-100" @onclick="Logout">Logout</button>
                    }
                    else
                    {
                        <div class="p-3">
                            <label class="form-label">Developer Key</label>
                            <input type="password" class="form-control mb-3" @bind="_secretKey" @bind:event="oninput" @onkeyup="HandleKeyUp" />
                            <button class="btn btn-primary w-100" @onclick="Login">Login</button>
                        </div>
                    }
                </div>
            </div>
            <div class="drawer-backdrop" @onclick="ToggleFeedback"></div>
        }
    </div>
    
    <Snackbar />
</main>

@code {
    private bool _showFeedback = false;
    private string _secretKey = "";

    protected override void OnInitialized()
    {
        VersionService.OnUpdateAvailable += async () => await InvokeAsync(StateHasChanged);
    }

    private void ToggleFeedback() 
    {
        _showFeedback = !_showFeedback;
    }

    private async Task Login()
    {
        if (await AuthService.Authenticate(_secretKey))
        {
            _secretKey = "";
            Snackbar.Show("Developer mode enabled.", "success");
        }
        else
        {
            Snackbar.Show("Invalid key.", "danger");
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await Login();
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        _showFeedback = false;
        Snackbar.Show("Developer mode disabled.", "info");
    }

    private void RefreshPage() => Navigation.NavigateTo(Navigation.Uri, forceLoad: true);

    private async Task SaveGame()
    {
        await Persistence.SaveAsync();
        Snackbar.Show("Game Saved!", "success");
    }

    private async Task LoadGame()
    {
        if (await Persistence.HasSave())
        {
            await Persistence.LoadAsync();
            Snackbar.Show("Game Loaded!", "success");
        }
        else
        {
            Snackbar.Show("No save found.", "warning");
        }
    }
}
