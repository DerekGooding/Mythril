@inherits LayoutComponentBase
@using Mythril.Blazor.Services
@inject PersistenceService Persistence
@inject SnackbarService Snackbar
@inject VersionService VersionService
@inject NavigationManager Navigation

<main>
    <div class="top-row px-4 justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-primary mx-2" @onclick="SaveGame">Save</button>
            <button class="btn btn-outline-secondary mx-2" @onclick="LoadGame">Load</button>
            <button class="btn btn-outline-info mx-2" @onclick="ToggleFeedback">Feedback</button>
        </div>
        
        <div class="version-info d-flex align-items-center">
            <span class="text-muted small mx-2">v: @(VersionService.CurrentVersion?.Substring(0, 7) ?? "local")</span>
            @if (VersionService.IsUpdateAvailable)
            {
                <button class="btn btn-sm btn-warning animate-pulse" @onclick="RefreshPage">
                    <span class="material-icons-outlined small" style="font-size: 1rem; vertical-align: middle;">refresh</span>
                    Update Available
                </button>
            }
        </div>
    </div>

    <div class="main-container">
        <article class="content">
            @Body
        </article>

        @if (_showFeedback)
        {
            <div class="feedback-drawer">
                <div class="drawer-header">
                    <h5>User Feedback (DEBUG: OPEN)</h5>
                    <button class="btn-close" @onclick="ToggleFeedback"></button>
                </div>
                <div class="drawer-content">
                    <FeedbackPanel />
                </div>
            </div>
            <div class="drawer-backdrop" @onclick="ToggleFeedback"></div>
        }
    </div>
    
    <Snackbar />
</main>

@code {
    private bool _showFeedback = false;

    protected override void OnInitialized()
    {
        VersionService.OnUpdateAvailable += async () => await InvokeAsync(StateHasChanged);
    }

    private void ToggleFeedback() 
    {
        Console.WriteLine($"Toggling Feedback. Current state: {_showFeedback}");
        _showFeedback = !_showFeedback;
    }

    private void RefreshPage() => Navigation.NavigateTo(Navigation.Uri, forceLoad: true);

    private async Task SaveGame()
    {
        await Persistence.SaveAsync();
        Snackbar.Show("Game Saved!", "success");
    }

    private async Task LoadGame()
    {
        if (await Persistence.HasSave())
        {
            await Persistence.LoadAsync();
            Snackbar.Show("Game Loaded!", "success");
            // Force reload to refresh state if needed, or rely on Blazor's reactivity if we wired it up correctly.
            // Since ResourceManager is a singleton and injected, components might need a state has changed trigger.
            // For now, a simple reload is the safest way to ensure all components reflect the new state if they aren't observing it.
            // But we can't easily force a full app reload in WASM without JS.
            // Let's assume the user will navigate or components will update on next interaction for now.
        }
        else
        {
            Snackbar.Show("No save found.", "warning");
        }
    }
}
